<VirtualHost *:80>
	ServerName		gss.grnet.gr
	ServerAdmin		root@noc.grnet.gr
	ServerSignature		On
	RewriteEngine		On

	# Redirect /gss/login and /gss/token to its HTTPS equivalent
	RewriteRule		^(/gss/login/?.*)$	https://gss.grnet.gr$1 [R]
	RewriteRule		^(/gss/token/?.*)$	https://gss.grnet.gr$1 [R]

	# Redirect /gss to /gss/
	RewriteRule		^/gss$			/gss/ [R]

	# Redirect everything except /gss/* and /webdav/* to /gss/$1
	RewriteCond		%{REQUEST_URI} !gss
	RewriteCond		%{REQUEST_URI} !webdav
	RewriteCond		%{REQUEST_URI} !rest-api-test
	RewriteCond		%{REQUEST_URI} !shibboleth
	RewriteCond		%{REQUEST_URI} !shibboleth-sp
	RewriteCond		%{REQUEST_URI} !Shibboleth.sso
	RewriteRule		(.*)			/gss$1 [R]

	DocumentRoot /var/www/
	<Directory />
		Options FollowSymLinks
		AllowOverride None
	</Directory>
	<Directory /var/www/>
		AllowOverride None
		Order deny,allow
	</Directory>

	JkMountCopy On
</VirtualHost>

<VirtualHost *:443>
	ServerName		gss.grnet.gr
	ServerAdmin		root@noc.grnet.gr
	ServerSignature		On

	RewriteEngine		On

	# Redirect everything besides /gss/login/ and /gss/token to plain HTTP	
	RewriteCond		%{REQUEST_URI} !gss/login
	RewriteCond		%{REQUEST_URI} !gss/token
	RewriteCond		%{REQUEST_URI} !shibboleth
	RewriteCond		%{REQUEST_URI} !shibboleth-sp
	RewriteCond		%{REQUEST_URI} !Shibboleth.sso
	RewriteRule		(.*)		http://gss.grnet.gr$1 [R]

	SSLEngine		on
	SSLCertificateFile	/etc/ssl/certs/gss.grnet.gr.crt
	SSLCertificateKeyFile	/etc/ssl/private/gss.grnet.gr.key
	SSLCACertificatePath	/etc/ssl/certs

	AddDefaultCharset	UTF-8
	IndexOptions		+Charset=UTF-8

	# Shibboleth SP configuration
	ShibConfig		/etc/shibboleth/shibboleth.xml
	ShibSchemaDir		/usr/share/xml/shibboleth

	<Files *.sso>
		SetHandler shib-handler
	</Files>

	Alias /shibboleth-sp /usr/share/shibboleth

	DocumentRoot /var/www/
	<Directory />
		Options FollowSymLinks
		AllowOverride None
	</Directory>
	<Directory /var/www/>
		AllowOverride None
		Order deny,allow
	</Directory>
#		Options Indexes ExecCGI -MultiViews +SymLinksIfOwnerMatch
#		AddHandler cgi-script .cgi
#		AllowOverride All
#		Order allow,deny
#		Allow from all
#
#		# shibboleth-sp authentication
#		AuthType shibboleth
#		ShibRequireSession On
#		require valid-user

	<Location /gss/login>
		AuthType shibboleth
		ShibRequireSession On
		require valid-user
	</Location>

	LogLevel warn
	ErrorLog /var/log/apache2/error.log
	CustomLog /var/log/apache2/access.log combined

	JkMountCopy On
</VirtualHost>
